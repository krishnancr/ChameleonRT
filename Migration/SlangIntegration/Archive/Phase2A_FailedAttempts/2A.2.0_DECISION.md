# Phase 2A.2 BLAS Strategy - Decision Summary

**Date:** October 10, 2025  
**Decision:** Approved - Option A (Temporary Per-Geometry Buffers)

---

## Executive Summary

After analyzing the DXR BLAS building code, I've documented the strategy in:
`Migration/SlangIntegration/Phase2A_Analysis/2A.2.0_BLAS_Strategy.md`

**Decision: Option A - Temporary Per-Geometry Buffers for BLAS Build**

This approach creates global buffers for shader access while keeping BLAS building unchanged by using temporary per-geometry buffers that are discarded after build.

---

## Key Findings

1. **Current BLAS Implementation:**
   - Creates per-geometry buffers (vertex, index, normal, UV)
   - Uses GPU virtual addresses directly in `D3D12_RAYTRACING_GEOMETRY_DESC`
   - Builds BLAS from these buffers, then keeps them for shader access (space1)

2. **D3D12 API Capability:**
   - CAN use global buffers with offset addresses for BLAS
   - BUT: Vertex stride mismatch (BLAS expects vec3=12 bytes, global uses Vertex=32 bytes)
   - Untested and risky for Phase 2A

3. **Chosen Strategy:**
   - Create global buffers for shader access (space0)
   - Create temporary per-geometry buffers for BLAS build (from scene.meshes data)
   - Discard temporary buffers after BLAS is built
   - Only global buffers remain for shaders

---

## Why This Is The Right Choice for Phase 2A

✅ **Low Risk:** BLAS building code stays unchanged (proven approach)  
✅ **Incremental:** Isolates shader refactor from BLAS changes  
✅ **Debuggable:** Can validate BLAS builds independently  
✅ **Compatible:** Avoids stride/format mismatches  
✅ **Reversible:** Can optimize to Option B in future phase  

---

## Implementation Impact

### Memory During Scene Load
- **Temporary spike:** Both temporary buffers + global buffers exist
- **After load:** Temporary buffers released, only global remain
- **Net result:** Lower final memory usage than before refactor

### Code Changes
- **BLAS loop:** NO CHANGES (add comment documenting strategy)
- **Global buffers:** NEW code at start of `set_scene()`
- **Shader access:** CHANGED (use global buffers in space0)

---

## Validation Criteria

1. BLAS sizes match before/after refactor (byte-exact)
2. TLAS builds successfully
3. No D3D12 validation errors
4. Rendering identical to baseline screenshots
5. Final GPU memory usage lower than before

---

## Next Steps

✅ **Analysis complete** - documented in `2A.2.0_BLAS_Strategy.md`  
→ **Proceed to Task 2A.2.1** - Update HLSL shader  
→ **Continue through Phase 2A.2** - DXR backend refactor  

---

**Ready to proceed with implementation using Option A strategy.**
