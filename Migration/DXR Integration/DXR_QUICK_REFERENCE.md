# DXR Backend - Quick Integration Reference

**Quick lookup for Slang integration work**

---

## 📁 File Locations

### Main Backend Files
- **Backend Class:** `backends/dxr/render_dxr.h` (lines 1-100)
- **Implementation:** `backends/dxr/render_dxr.cpp` (945 lines)
- **Pipeline Creation:** `render_dxr.cpp` lines 590-645 (`build_raytracing_pipeline()`)

### Shader Files
- **Main Shader:** `backends/dxr/render_dxr.hlsl` (329 lines)
- **Utilities:** `util.hlsl`, `lcg_rng.hlsl`, `disney_bsdf.hlsl`, `lights.hlsl`

### Build System
- **CMake Function:** `backends/dxr/cmake/FindD3D12.cmake` lines 58-117
- **Build Config:** `backends/dxr/CMakeLists.txt` lines 20-32

---

## 🔧 Current Shader Compilation System

### How It Works Now
```
Build Time:
  HLSL files → DXC compiler → DXIL bytecode → Embedded C header
  
Runtime:
  Load embedded bytecode → Create shader library → Build pipeline
```

### Key Point
**No runtime shader compilation exists!** All compilation happens at CMake build time.

---

## 🎯 Entry Points & Shader Stages

| Entry Point | Type | Purpose |
|-------------|------|---------|
| `RayGen` | Ray Gen | Generate camera rays |
| `Miss` | Miss | Primary ray background |
| `ShadowMiss` | Miss | Shadow rays (black) |
| `ClosestHit` | Closest Hit | Surface shading |

**Shader Model:** `lib_6_3` (DXR library)

---

## 🔍 Where to Add Slang Integration

### Option A: CMake Only (Recommended First)

**File:** `backends/dxr/cmake/FindD3D12.cmake`
**Function:** `add_dxil_embed_library()`
**Lines:** 95-102

**Current DXC command:**
```cmake
COMMAND ${D3D12_SHADER_COMPILER} ${MAIN_SHADER}
  -T lib_6_3 -Fh ${DXIL_EMBED_FILE} -Vn ${FNAME}_dxil
```

**Replace with Slang:**
```cmake
if(ENABLE_DXR_SLANG)
    COMMAND ${SLANG_COMPILER} ${MAIN_SHADER}
      -target dxil -profile sm_6_3
      -o ${DXIL_EMBED_FILE} -embed-dxil
else()
    # Original DXC command
endif()
```

### Option B: Runtime Compilation (Later)

**File:** `backends/dxr/render_dxr.cpp`
**Function:** `build_raytracing_pipeline()`
**Lines:** 590-595

**Current code:**
```cpp
dxr::ShaderLibrary shader_library(render_dxr_dxil,
                                  sizeof(render_dxr_dxil),
                                  {L"RayGen", L"Miss", L"ClosestHit", L"ShadowMiss"});
```

**Add Slang path:**
```cpp
#ifdef USE_SLANG_RUNTIME
    auto hlsl = loadShaderSource("render_dxr.hlsl");
    auto dxil = slangCompiler.compileHLSLToDXIL(hlsl, ...);
    dxr::ShaderLibrary shader_library(dxil.data(), dxil.size(), {...});
#else
    dxr::ShaderLibrary shader_library(render_dxr_dxil, sizeof(render_dxr_dxil), {...});
#endif
```

---

## 📝 Class Members to Add (Phase 2)

**File:** `backends/dxr/render_dxr.h`

```cpp
#ifdef USE_SLANG_COMPILER
    chameleonrt::SlangShaderCompiler slangCompiler;
#endif
```

**Include at top of render_dxr.cpp:**
```cpp
#ifdef USE_SLANG_COMPILER
#include "slang_shader_compiler.h"
#endif
```

---

## ⚙️ Build Commands

### Configure with Slang
```powershell
cmake -B build -DENABLE_SLANG=ON -DENABLE_DXR=ON -DENABLE_DXR_SLANG=ON -DSlang_ROOT=C:\dev\slang\build\Debug
```

### Build
```powershell
cmake --build build --config Debug --target crt_dxr
```

### Test
```powershell
cd build\Debug
.\chameleonrt.exe dxr ..\..\test_cube.obj
```

---

## 🧪 Verification Steps

1. **Build succeeds** → Embedded header generated
2. **Application runs** → Pipeline creates without errors
3. **Renders correctly** → Visual comparison with DXC version
4. **No validation errors** → Run with D3D12 debug layer
5. **Performance acceptable** → Within 5% of DXC version

---

## 🐛 Debug Tools

### Disassemble DXIL
```powershell
dxc -dumpbin render_dxr_embedded_dxil.dxil > assembly.txt
```

### Compare Bytecode
```powershell
fc dxc_output.dxil slang_output.dxil
```

### PIX Capture
- Capture frame
- Inspect pipeline state
- Verify shader bytecode loaded

---

## 📋 Quick Checklist

### Phase 1: CMake Integration
- [ ] Find DXC in `FindD3D12.cmake`
- [ ] Add Slang compiler detection
- [ ] Modify `add_dxil_embed_library()` function
- [ ] Add `ENABLE_DXR_SLANG` option
- [ ] Test build
- [ ] Verify header generated
- [ ] Test runtime
- [ ] Compare output

### Phase 2: Runtime Path
- [ ] Add `SlangShaderCompiler` member
- [ ] Add runtime compilation code
- [ ] Test hot-reload
- [ ] Measure performance impact

---

## 🎓 Key Concepts

### DXR Shader Libraries
- All shaders compiled as **single library** (`-T lib_6_3`)
- Multiple entry points exported from one DXIL blob
- State object references exports by name

### Embedded Bytecode
- Header file contains: `unsigned char render_dxr_dxil[]`
- Generated by DXC `-Fh` flag
- Linked directly into binary at compile time

### State Object Creation
- `D3D12_STATE_OBJECT_DESC` references shader library
- Exports bound to pipeline by name (`L"RayGen"`, etc.)
- Root signatures associated with shader groups

---

## 🚀 Recommended Path Forward

1. **Start with CMake changes only**
   - Lowest risk
   - No C++ code changes
   - Easy to test and rollback

2. **Verify DXIL output matches**
   - Use disassembly comparison
   - Check header file format

3. **Test rendering**
   - Visual verification
   - Validation layers
   - Performance benchmark

4. **Add runtime path later**
   - After build-time path proven
   - Useful for iteration

---

**For full details, see:** `DXR_INTEGRATION_TARGET_FILES.md`
